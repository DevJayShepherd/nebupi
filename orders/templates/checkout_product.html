{% extends 'base.html' %}

{% load static %}

{% block title %}
  Checkout
{% endblock %}

{% block content %}
  <!-- HEADER -->
  <header class="bg-dark pt-9 pb-11 d-none d-md-block">
    <div class="container-md">
      <div class="row align-items-center">
        <div class="col">
          <!-- Heading -->
          <h1 class="fw-bold text-white mb-2">One-Time Payment Checkout (Demo)</h1>
        </div>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="pb-8 pb-md-11 mt-md-n6">
    <div class="container-md">
      <div class="row">
        <div class="col-12 col-sm-10 offset-sm-1 col-md-8 offset-md-2">
          <div class="card card-bleed shadow-light-lg mb-4">
            <!-- Card body -->
            <div class="p-5 text-center">
              <div id="error-container"></div>
              <div class="mb-5 mt-3">
                <h1 class="fw-bold">{{ product.display_name }}</h1>
                <p class="mb-0">
                  Purchase <span class="text-dark fw-medium">{{ product.display_name }} and download now!</span>
                </p>
              </div>
              <div class="d-flex justify-content-center">
                <span class="h3 mb-0 fw-bold text-primary">$</span>
                <div class="display-4 fw-bold text-primary">{{ product.price|stringformat:'d' }}</div>
              </div>
            </div>
            <hr class="m-0" />
            <div class="p-5">
              <div id="paypal-button-container"></div>
            </div>
            <!-- hr -->
            <hr class="m-0" />
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- PayPal -->
  <p id="result-message"></p>
  <script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=USD"></script>
  <script>
    // Render the PayPal button into #paypal-button-container
    paypal
      .Buttons({
        // Call your server to set up the transaction
        createOrder: function (data, actions) {
          return fetch('/paypal/orders/create/', {
            method: 'post',
            headers: {
              'content-type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
              product_id: {{ product.product_id }}
            })
          })
            .then(function (res) {
              return res.json()
            })
            .then(function (orderData) {
              return orderData.id
            })
        },
    
        // Call your server to finalize the transaction
        onApprove: function (data, actions) {
          return fetch('/paypal/orders/' + data.orderID + '/capture/', {
            method: 'post',
            headers: {
              'content-type': 'application/json',
              'X-CSRFToken': '{{ csrf_token }}'
            }
          })
            .then(function (res) {
              return res.json()
            })
            .then(function (orderData) {
              // Three cases to handle:
              //   (1) Recoverable INSTRUMENT_DECLINED -> call actions.restart()
              //   (2) Other non-recoverable errors -> Show a failure message
              //   (3) Successful transaction -> Show confirmation or thank you
    
              // This example reads a v2/checkout/orders capture response, propagated from the server
              // You could use a different API or structure for your 'orderData'
              var errorDetail = Array.isArray(orderData.details) && orderData.details[0]
    
              if (errorDetail && errorDetail.issue === 'INSTRUMENT_DECLINED') {
                return actions.restart() // Recoverable state, per:
                // https://developer.paypal.com/docs/checkout/integration-features/funding-failure/
              }
    
              if (errorDetail) {
                var msg = 'Your transaction could not be processed.'
                if (errorDetail.description) msg += '\n\n' + errorDetail.description
                if (orderData.debug_id) msg += ' (' + orderData.debug_id + ')'
    
                // get the error container
                var errorContainer = document.getElementById('error-container')
                // add an html element with the error message
                errorContainer.innerHTML = `
                    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                        <strong>Sorry! </strong>` + msg +`
                        <p>Please try again or contact us if the problem persists.</p>
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>`

                return
              }
    
              window.location.href = "{% url 'thank_you' %}"
            })
        }
      })
      .render('#paypal-button-container')
  </script>
  <!-- End Paypal -->
{% endblock %}
